<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡äºŒç»´ç é•¿æŒ‰è¯†åˆ«</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .qr-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px auto;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .qr-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .qr-image:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .qr-image.long-pressing {
            transform: scale(0.98);
            filter: brightness(0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .instructions {
            margin-top: 20px;
            color: #666;
            font-size: 16px;
        }
        
        .status-text {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            min-height: 20px;
        }
        
        .status-text.idle {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .status-text.pressing {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-text.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-text.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ee5a24);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 3px;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.9);
            color: #333;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: white;
            transform: scale(1.05);
        }
        
        .feature-list {
            text-align: left;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <a href="/" class="back-btn">â† è¿”å›é¦–é¡µ</a>
    
    <div class="container">
        <header>
            <h1>ğŸ“± å¾®ä¿¡äºŒç»´ç é•¿æŒ‰è¯†åˆ«</h1>
            <p class="subtitle">æ¨¡æ‹Ÿå¾®ä¿¡é•¿æŒ‰äºŒç»´ç è¯†åˆ«åŠŸèƒ½</p>
        </header>

        <div class="qr-container">
            <h2>è‡ªåŠ¨è¯†åˆ«äºŒç»´ç </h2>
            <div class="instructions">
                <p>é¡µé¢å°†è‡ªåŠ¨è¯†åˆ«ä¸‹æ–¹äºŒç»´ç å›¾ç‰‡ï¼Œæ¨¡æ‹Ÿå¾®ä¿¡è¯†åˆ«è¿‡ç¨‹</p>
            </div>
            <img src="./4.jpg" alt="å¾®ä¿¡äºŒç»´ç " id="qrImage">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            
            <div id="statusText" class="status-text idle">
                æ­£åœ¨å‡†å¤‡è‡ªåŠ¨è¯†åˆ«äºŒç»´ç ...
            </div>
        </div>
        
        <div class="comparison-table">
            <h2>ğŸ”§ åŠŸèƒ½ç‰¹ç‚¹</h2>
            <ul class="feature-list">
                <li>âœ… é•¿æŒ‰æ‰‹åŠ¿è¯†åˆ«ï¼ˆ1.5ç§’è§¦å‘ï¼‰</li>
                <li>âœ… è§†è§‰åé¦ˆå’Œè¿›åº¦æ¡</li>
                <li>âœ… äºŒç»´ç å†…å®¹è§£æ</li>
                <li>âœ… è‡ªåŠ¨è·³è½¬é€»è¾‘</li>
                <li>âœ… ç§»åŠ¨ç«¯è§¦æ‘¸æ”¯æŒ</li>
                <li>âœ… é˜²è¯¯è§¦è®¾è®¡</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        // æ£€æŸ¥jsQRåº“æ˜¯å¦æ­£ç¡®åŠ è½½
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            console.log('jsQRåº“çŠ¶æ€:', typeof jsQR !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½');
            if (typeof jsQR === 'undefined') {
                console.error('jsQRåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        });
    </script>
    

    <script>
        class QRLongPressDetector {
            constructor() {
                this.qrImage = document.getElementById('qrImage');
                this.statusText = document.getElementById('statusText');
                this.progressFill = document.getElementById('progressFill');
                
                this.isPressed = false;
                this.pressTimer = null;
                this.progressTimer = null;
                this.pressStartTime = 0;
                
                this.LONG_PRESS_DURATION = 1500; // 1.5ç§’
                this.PROGRESS_INTERVAL = 50; // 50msæ›´æ–°ä¸€æ¬¡è¿›åº¦
                
                this.initEventListeners();
            }
            
            initEventListeners() {
                // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
                this.qrImage.addEventListener('mousedown', (e) => this.startPress(e));
                this.qrImage.addEventListener('mouseup', (e) => this.endPress(e));
                this.qrImage.addEventListener('mouseleave', (e) => this.endPress(e));
                
                // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                this.qrImage.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startPress(e);
                });
                this.qrImage.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.endPress(e);
                });
                this.qrImage.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    this.endPress(e);
                });
                
                // å³é”®èœå•ç¦ç”¨
                this.qrImage.addEventListener('contextmenu', (e) => e.preventDefault());
            }
            
            startPress(event) {
                if (this.isPressed) return;
                
                this.isPressed = true;
                this.pressStartTime = Date.now();
                
                // æ·»åŠ è§†è§‰åé¦ˆ
                this.qrImage.classList.add('long-pressing');
                this.updateStatus('pressing', 'æ­£åœ¨è¯†åˆ«ä¸­...');
                
                // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
                this.startProgressAnimation();
                
                // è®¾ç½®é•¿æŒ‰å®šæ—¶å™¨
                this.pressTimer = setTimeout(() => {
                    this.onLongPressComplete();
                }, this.LONG_PRESS_DURATION);
            }
            
            endPress(event) {
                if (!this.isPressed) return;
                
                this.isPressed = false;
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (this.pressTimer) {
                    clearTimeout(this.pressTimer);
                    this.pressTimer = null;
                }
                
                if (this.progressTimer) {
                    clearInterval(this.progressTimer);
                    this.progressTimer = null;
                }
                
                // ç§»é™¤è§†è§‰åé¦ˆ
                this.qrImage.classList.remove('long-pressing');
                this.resetProgress();
                
                const pressDuration = Date.now() - this.pressStartTime;
                if (pressDuration < this.LONG_PRESS_DURATION) {
                    this.updateStatus('idle', 'è¯†åˆ«æ—¶é—´ä¸å¤Ÿï¼Œè¯·é‡è¯•...');
                    setTimeout(() => {
                        this.updateStatus('idle', 'ç‚¹å‡»å›¾ç‰‡å¯æ‰‹åŠ¨è¯†åˆ«ï¼Œæˆ–ç­‰å¾…è‡ªåŠ¨è¯†åˆ«...');
                    }, 2000);
                }
            }
            
            startProgressAnimation() {
                this.progressTimer = setInterval(() => {
                    if (!this.isPressed) return;
                    
                    const elapsed = Date.now() - this.pressStartTime;
                    const progress = Math.min((elapsed / this.LONG_PRESS_DURATION) * 100, 100);
                    this.progressFill.style.width = progress + '%';
                }, this.PROGRESS_INTERVAL);
            }
            
            resetProgress() {
                this.progressFill.style.width = '0%';
            }
            
            onLongPressComplete() {
                this.isPressed = false;
                this.qrImage.classList.remove('long-pressing');
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (this.progressTimer) {
                    clearInterval(this.progressTimer);
                    this.progressTimer = null;
                }
                
                // å®Œæˆè¿›åº¦æ¡
                this.progressFill.style.width = '100%';
                
                this.updateStatus('success', 'è¯†åˆ«æˆåŠŸï¼æ­£åœ¨è§£æäºŒç»´ç ...');
                
                // æ¨¡æ‹ŸäºŒç»´ç è¯†åˆ«è¿‡ç¨‹
                setTimeout(() => {
                    this.recognizeQRCode();
                }, 500);
            }
            
            async recognizeQRCode() {
                try {
                    console.log('å¼€å§‹äºŒç»´ç è¯†åˆ«...');
                    console.log('jsQRåº“çŠ¶æ€:', typeof jsQR !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
                    
                    // åˆ›å»ºcanvasæ¥è¯»å–å›¾ç‰‡æ•°æ®
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ç­‰å¾…å›¾ç‰‡åŠ è½½
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ, å°ºå¯¸:', img.width, 'x', img.height);
                        
                        // å¦‚æœå›¾ç‰‡å¤ªå¤§ï¼Œå…ˆç¼©å°åˆ°åˆé€‚çš„å°ºå¯¸
                        const maxSize = 600;
                        let drawWidth = img.width;
                        let drawHeight = img.height;
                        
                        if (img.width > maxSize || img.height > maxSize) {
                            const ratio = Math.min(maxSize / img.width, maxSize / img.height);
                            drawWidth = Math.floor(img.width * ratio);
                            drawHeight = Math.floor(img.height * ratio);
                            console.log('å›¾ç‰‡è¿‡å¤§ï¼Œç¼©æ”¾åˆ°:', drawWidth, 'x', drawHeight);
                        }
                        
                        canvas.width = drawWidth;
                        canvas.height = drawHeight;
                        ctx.drawImage(img, 0, 0, drawWidth, drawHeight);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        console.log('å›¾åƒæ•°æ®è·å–æˆåŠŸ, æ•°æ®é•¿åº¦:', imageData.data.length);
                        
                        // ä½¿ç”¨jsQRåº“è¯†åˆ«äºŒç»´ç 
                        if (typeof jsQR !== 'undefined') {
                            console.log('ä½¿ç”¨jsQRåº“è¿›è¡Œè¯†åˆ«...');
                            const code = jsQR(imageData.data, imageData.width, imageData.height);
                            console.log('è¯†åˆ«ç»“æœ:', code);
                            
                            if (code) {
                                console.log('è¯†åˆ«æˆåŠŸ! å†…å®¹:', code.data);
                                this.handleQRResult(code.data);
                            } else {
                                console.log('jsQRè¯†åˆ«å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•...');
                                // å°è¯•è°ƒæ•´å›¾åƒå¢å¼ºè¯†åˆ«æ•ˆæœ
                                this.tryEnhancedRecognition(canvas, ctx, imageData);
                            }
                        } else {
                            console.log('jsQRåº“æœªåŠ è½½ï¼Œä½¿ç”¨æ¨¡æ‹Ÿç»“æœ');
                            this.simulateQRResult();
                        }
                    };
                    
                    img.onerror = (error) => {
                        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
                        this.simulateQRResult();
                    };
                    
                    console.log('è®¾ç½®å›¾ç‰‡æº:', this.qrImage.src.substring(0, 50) + '...');
                    img.src = this.qrImage.src;
                    
                } catch (error) {
                    console.error('äºŒç»´ç è¯†åˆ«å‡ºé”™:', error);
                    this.simulateQRResult();
                }
            }
            
            tryEnhancedRecognition(canvas, ctx, originalImageData) {
                console.log('å°è¯•å›¾åƒå¢å¼ºè¯†åˆ«...');
                
                // æ–¹æ³•1: å¢åŠ å¯¹æ¯”åº¦
                const enhancedImageData = ctx.createImageData(originalImageData.width, originalImageData.height);
                for (let i = 0; i < originalImageData.data.length; i += 4) {
                    const avg = (originalImageData.data[i] + originalImageData.data[i + 1] + originalImageData.data[i + 2]) / 3;
                    const enhanced = avg > 128 ? 255 : 0; // äºŒå€¼åŒ–
                    
                    enhancedImageData.data[i] = enhanced;     // R
                    enhancedImageData.data[i + 1] = enhanced; // G
                    enhancedImageData.data[i + 2] = enhanced; // B
                    enhancedImageData.data[i + 3] = 255;      // A
                }
                
                const code = jsQR(enhancedImageData.data, enhancedImageData.width, enhancedImageData.height);
                console.log('å¢å¼ºè¯†åˆ«ç»“æœ:', code);
                
                if (code) {
                    console.log('å¢å¼ºè¯†åˆ«æˆåŠŸ! å†…å®¹:', code.data);
                    this.handleQRResult(code.data);
                } else {
                    // æ–¹æ³•2: å°è¯•ä¸åŒçš„ç¼©æ”¾
                    this.tryScaledRecognition(canvas, ctx, originalImageData);
                }
            }
            
            tryScaledRecognition(canvas, ctx, originalImageData) {
                console.log('å°è¯•ç¼©æ”¾è¯†åˆ«...');
                
                // å°è¯•æ”¾å¤§å›¾åƒ
                const scaleFactor = 2;
                const scaledCanvas = document.createElement('canvas');
                const scaledCtx = scaledCanvas.getContext('2d');
                
                scaledCanvas.width = originalImageData.width * scaleFactor;
                scaledCanvas.height = originalImageData.height * scaleFactor;
                
                // é‡æ–°ç»˜åˆ¶æ”¾å¤§çš„å›¾åƒ
                ctx.putImageData(originalImageData, 0, 0);
                scaledCtx.imageSmoothingEnabled = false; // é¿å…æ¨¡ç³Š
                scaledCtx.drawImage(canvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
                
                const scaledImageData = scaledCtx.getImageData(0, 0, scaledCanvas.width, scaledCanvas.height);
                const code = jsQR(scaledImageData.data, scaledImageData.width, scaledImageData.height);
                console.log('ç¼©æ”¾è¯†åˆ«ç»“æœ:', code);
                
                if (code) {
                    console.log('ç¼©æ”¾è¯†åˆ«æˆåŠŸ! å†…å®¹:', code.data);
                    this.handleQRResult(code.data);
                } else {
                    console.log('æ‰€æœ‰è¯†åˆ«æ–¹æ³•éƒ½å¤±è´¥äº†');
                    this.updateStatus('error', 'æœªèƒ½è¯†åˆ«äºŒç»´ç å†…å®¹ï¼Œè¯·å°è¯•å…¶ä»–å›¾ç‰‡');
                }
            }
            
            simulateQRResult() {
                // æ¨¡æ‹Ÿè¯†åˆ«ç»“æœ
                const mockData = 'https://u.wechat.com/ELAxxxxxxxxxxxx';
                this.updateStatus('success', 'è¯†åˆ«æˆåŠŸï¼å‘ç°å¾®ä¿¡æ·»åŠ å¥½å‹é“¾æ¥');
                
                setTimeout(() => {
                    this.handleQRResult(mockData);
                }, 1000);
            }
            
            handleQRResult(qrData) {
                console.log('äºŒç»´ç å†…å®¹:', qrData);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å¾®ä¿¡ç›¸å…³é“¾æ¥
                if (qrData.includes('wechat.com') || qrData.includes('weixin') || qrData.includes('u.wechat.com')) {
                    this.updateStatus('success', 'æ£€æµ‹åˆ°å¾®ä¿¡äºŒç»´ç ï¼æ­£åœ¨è·³è½¬...');
                    
                    setTimeout(() => {
                        this.redirectToWeChat(qrData);
                    }, 1500);
                } else if (qrData.startsWith('http')) {
                    this.updateStatus('success', 'æ£€æµ‹åˆ°ç½‘é¡µé“¾æ¥ï¼æ­£åœ¨è·³è½¬...');
                    
                    setTimeout(() => {
                        window.open(qrData, '_blank');
                        this.updateStatus('success', 'å·²åœ¨æ–°çª—å£æ‰“å¼€é“¾æ¥');
                    }, 1500);
                } else {
                    this.updateStatus('success', `è¯†åˆ«åˆ°å†…å®¹: ${qrData}`);
                }
                
                // 3ç§’åé‡ç½®çŠ¶æ€
                setTimeout(() => {
                    this.resetProgress();
                    this.updateStatus('idle', 'è¯†åˆ«å®Œæˆï¼ç‚¹å‡»å›¾ç‰‡å¯é‡æ–°è¯†åˆ«...');
                }, 3000);
            }
            
            redirectToWeChat(qrData) {

                console.log(qrData);
                // å°è¯•æ‰“å¼€å¾®ä¿¡
                const userAgent = navigator.userAgent.toLowerCase();
                
                if (userAgent.includes('micromessenger')) {
                    // åœ¨å¾®ä¿¡å†…éƒ¨ï¼Œç›´æ¥è·³è½¬
                    window.location.href = qrData;
                } else if (userAgent.includes('mobile')) {
                    // ç§»åŠ¨ç«¯ï¼Œå°è¯•ä½¿ç”¨å¾®ä¿¡scheme
                    const wechatScheme = `weixin://dl/business/?t=9XPl7k7i2lC`;
                    window.location.href = wechatScheme;
                    
                    // å¦‚æœå¾®ä¿¡schemeå¤±è´¥ï¼Œæç¤ºç”¨æˆ·
                    setTimeout(() => {
                        this.updateStatus('error', 'è¯·åœ¨å¾®ä¿¡ä¸­æ‰“å¼€æˆ–å¤åˆ¶é“¾æ¥åˆ°å¾®ä¿¡');
                    }, 2000);
                } else {
                    // æ¡Œé¢ç«¯ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                    this.updateStatus('success', 'æ£€æµ‹åˆ°å¾®ä¿¡äºŒç»´ç ï¼è¯·åœ¨æ‰‹æœºå¾®ä¿¡ä¸­æ‰«æ');
                    
                    // åˆ›å»ºæç¤ºå¼¹çª—
                    this.showWeChatTip(qrData);
                }
            }
            
            showWeChatTip(qrData) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        text-align: center;
                        max-width: 400px;
                        margin: 20px;
                    ">
                        <h3>ğŸ¯ è¯†åˆ«æˆåŠŸï¼</h3>
                        <p style="margin: 15px 0;">æ£€æµ‹åˆ°å¾®ä¿¡æ·»åŠ å¥½å‹äºŒç»´ç </p>
                        <p style="color: #666; font-size: 14px;">è¯·ä½¿ç”¨æ‰‹æœºå¾®ä¿¡æ‰«ææ­¤äºŒç»´ç </p>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            margin-top: 20px;
                            padding: 10px 25px;
                            background: #1aad19;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">æˆ‘çŸ¥é“äº†</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 3ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (modal.parentElement) {
                        modal.remove();
                    }
                }, 5000);
            }
            
            updateStatus(type, message) {
                this.statusText.className = `status-text ${type}`;
                this.statusText.textContent = message;
            }
            
            // è‡ªåŠ¨å¼€å§‹è¯†åˆ«
            autoStartRecognition() {
                this.updateStatus('pressing', 'ğŸ¤– è‡ªåŠ¨è¯†åˆ«ä¸­...');
                
                // æ·»åŠ è§†è§‰åé¦ˆ
                this.qrImage.classList.add('long-pressing');
                
                // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
                this.isPressed = true;
                this.pressStartTime = Date.now();
                this.startProgressAnimation();
                
                // è®¾ç½®è‡ªåŠ¨è¯†åˆ«å®šæ—¶å™¨
                this.pressTimer = setTimeout(() => {
                    this.onLongPressComplete();
                }, this.LONG_PRESS_DURATION);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const detector = new QRLongPressDetector();
            
            // è‡ªåŠ¨å¯åŠ¨è¯†åˆ«ï¼ˆå»¶è¿Ÿ1ç§’è®©ç”¨æˆ·çœ‹åˆ°ç•Œé¢ï¼‰
            setTimeout(() => {
                detector.autoStartRecognition();
            }, 1000);
        });
    </script>
</body>
</html> 