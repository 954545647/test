<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信二维码长按识别</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .qr-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px auto;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .qr-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .qr-image:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .qr-image.long-pressing {
            transform: scale(0.98);
            filter: brightness(0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .instructions {
            margin-top: 20px;
            color: #666;
            font-size: 16px;
        }
        
        .status-text {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            min-height: 20px;
        }
        
        .status-text.idle {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .status-text.pressing {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-text.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-text.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ee5a24);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 3px;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.9);
            color: #333;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: white;
            transform: scale(1.05);
        }
        
        .feature-list {
            text-align: left;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <a href="/" class="back-btn">← 返回首页</a>
    
    <div class="container">
        <header>
            <h1>📱 微信二维码长按识别</h1>
            <p class="subtitle">模拟微信长按二维码识别功能</p>
        </header>

        <div class="qr-container">
            <h2>自动识别二维码</h2>
            <div class="instructions">
                <p>页面将自动识别下方二维码图片，模拟微信识别过程</p>
            </div>
            <img src="./2.jpg" alt="微信二维码" id="qrImage">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            
            <div id="statusText" class="status-text idle">
                正在准备自动识别二维码...
            </div>
        </div>
        
        <div class="comparison-table">
            <h2>🔧 功能特点</h2>
            <ul class="feature-list">
                <li>✅ 长按手势识别（1.5秒触发）</li>
                <li>✅ 视觉反馈和进度条</li>
                <li>✅ 二维码内容解析</li>
                <li>✅ 自动跳转逻辑</li>
                <li>✅ 移动端触摸支持</li>
                <li>✅ 防误触设计</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        // 检查jsQR库是否正确加载
        window.addEventListener('load', function() {
            console.log('页面加载完成');
            console.log('jsQR库状态:', typeof jsQR !== 'undefined' ? '✅ 已加载' : '❌ 未加载');
            if (typeof jsQR === 'undefined') {
                console.error('jsQR库加载失败，请检查网络连接');
            }
        });
    </script>
    

    <script>
        class QRLongPressDetector {
            constructor() {
                this.qrImage = document.getElementById('qrImage');
                this.statusText = document.getElementById('statusText');
                this.progressFill = document.getElementById('progressFill');
                
                this.isPressed = false;
                this.pressTimer = null;
                this.progressTimer = null;
                this.pressStartTime = 0;
                this.humanRandomnessTimer = null;
                
                // 动态长按时长，避免固定模式
                this.LONG_PRESS_DURATION = 1400 + Math.random() * 400; // 1.4-1.8秒随机
                this.PROGRESS_INTERVAL = 45 + Math.random() * 20; // 45-65ms随机间隔
                
                this.initEventListeners();
            }
            
            initEventListeners() {
                // 鼠标事件（桌面端）
                this.qrImage.addEventListener('mousedown', (e) => this.startPress(e));
                this.qrImage.addEventListener('mouseup', (e) => this.endPress(e));
                this.qrImage.addEventListener('mouseleave', (e) => this.endPress(e));
                
                // 触摸事件（移动端）
                this.qrImage.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startPress(e);
                });
                this.qrImage.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.endPress(e);
                });
                this.qrImage.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    this.endPress(e);
                });
                
                // 右键菜单禁用
                this.qrImage.addEventListener('contextmenu', (e) => e.preventDefault());
                
                // 添加点击事件用于手动触发高级模拟
                this.qrImage.addEventListener('click', (e) => {
                    if (!this.isPressed) {
                        console.log('手动点击 - 使用高级事件模拟');
                        this.advancedEventSimulation();
                    }
                });
            }
            
            startPress(event) {
                if (this.isPressed) return;
                
                this.isPressed = true;
                this.pressStartTime = Date.now();
                
                // 添加视觉反馈
                this.qrImage.classList.add('long-pressing');
                this.updateStatus('pressing', '正在识别中...');
                
                // 开始进度条动画
                this.startProgressAnimation();
                
                // 启动人类随机性模拟
                this.startHumanRandomness();
                
                // 动态调整长按时长
                const dynamicDuration = this.LONG_PRESS_DURATION + (Math.random() - 0.5) * 200;
                
                // 设置长按定时器
                this.pressTimer = setTimeout(() => {
                    this.onLongPressComplete();
                }, dynamicDuration);
            }
            
            endPress(event) {
                if (!this.isPressed) return;
                
                this.isPressed = false;
                
                // 清除所有定时器
                if (this.pressTimer) {
                    clearTimeout(this.pressTimer);
                    this.pressTimer = null;
                }
                
                if (this.progressTimer) {
                    clearInterval(this.progressTimer);
                    this.progressTimer = null;
                }
                
                if (this.humanRandomnessTimer) {
                    clearInterval(this.humanRandomnessTimer);
                    this.humanRandomnessTimer = null;
                }
                
                // 移除视觉反馈
                this.qrImage.classList.remove('long-pressing');
                this.qrImage.style.transform = ''; // 重置变换
                this.resetProgress();
                
                const pressDuration = Date.now() - this.pressStartTime;
                if (pressDuration < this.LONG_PRESS_DURATION - 200) {
                    this.updateStatus('idle', '识别时间不够，请重试...');
                    setTimeout(() => {
                        this.updateStatus('idle', '点击图片可手动识别，或等待自动识别...');
                    }, 2000);
                }
            }
            
            startProgressAnimation() {
                this.progressTimer = setInterval(() => {
                    if (!this.isPressed) return;
                    
                    const elapsed = Date.now() - this.pressStartTime;
                    const progress = Math.min((elapsed / this.LONG_PRESS_DURATION) * 100, 100);
                    this.progressFill.style.width = progress + '%';
                }, this.PROGRESS_INTERVAL);
            }
            
            resetProgress() {
                this.progressFill.style.width = '0%';
            }
            
            onLongPressComplete() {
                this.isPressed = false;
                this.qrImage.classList.remove('long-pressing');
                this.qrImage.style.transform = ''; // 重置任何变换
                
                // 清除所有定时器
                if (this.progressTimer) {
                    clearInterval(this.progressTimer);
                    this.progressTimer = null;
                }
                
                if (this.humanRandomnessTimer) {
                    clearInterval(this.humanRandomnessTimer);
                    this.humanRandomnessTimer = null;
                }
                
                // 完成进度条
                this.progressFill.style.width = '100%';
                
                this.updateStatus('success', '长按识别完成！正在使用增强算法解析二维码...');
                
                // 添加随机延迟，模拟处理时间
                const processingDelay = 300 + Math.random() * 400;
                setTimeout(() => {
                    this.recognizeQRCode();
                }, processingDelay);
            }
            
            async recognizeQRCode() {
                try {
                    console.log('开始二维码识别...');
                    console.log('jsQR库状态:', typeof jsQR !== 'undefined' ? '已加载' : '未加载');
                    
                    // 创建canvas来读取图片数据
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // 等待图片加载
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        console.log('图片加载成功, 尺寸:', img.width, 'x', img.height);
                        
                        // 如果图片太大，先缩小到合适的尺寸
                        const maxSize = 600;
                        let drawWidth = img.width;
                        let drawHeight = img.height;
                        
                        if (img.width > maxSize || img.height > maxSize) {
                            const ratio = Math.min(maxSize / img.width, maxSize / img.height);
                            drawWidth = Math.floor(img.width * ratio);
                            drawHeight = Math.floor(img.height * ratio);
                            console.log('图片过大，缩放到:', drawWidth, 'x', drawHeight);
                        }
                        
                        canvas.width = drawWidth;
                        canvas.height = drawHeight;
                        ctx.drawImage(img, 0, 0, drawWidth, drawHeight);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        console.log('图像数据获取成功, 数据长度:', imageData.data.length);
                        
                        // 使用jsQR库识别二维码
                        if (typeof jsQR !== 'undefined') {
                            console.log('使用jsQR库进行识别...');
                            
                            // 首先尝试原始图像
                            let code = jsQR(imageData.data, imageData.width, imageData.height);
                            console.log('原始图像识别结果:', code);
                            
                            if (!code) {
                                // 尝试灰度处理
                                console.log('尝试灰度处理...');
                                const grayImageData = ctx.createImageData(imageData.width, imageData.height);
                                for (let i = 0; i < imageData.data.length; i += 4) {
                                    const gray = imageData.data[i] * 0.299 + imageData.data[i + 1] * 0.587 + imageData.data[i + 2] * 0.114;
                                    grayImageData.data[i] = gray;
                                    grayImageData.data[i + 1] = gray;
                                    grayImageData.data[i + 2] = gray;
                                    grayImageData.data[i + 3] = 255;
                                }
                                code = jsQR(grayImageData.data, grayImageData.width, grayImageData.height);
                                console.log('灰度处理识别结果:', code);
                            }
                            
                            if (code) {
                                console.log('识别成功! 内容:', code.data);
                                this.handleQRResult(code.data);
                            } else {
                                console.log('基础识别失败，尝试增强方法...');
                                // 尝试调整图像增强识别效果
                                this.tryEnhancedRecognition(canvas, ctx, imageData);
                            }
                        } else {
                            console.log('jsQR库未加载，使用模拟结果');
                            this.simulateQRResult();
                        }
                    };
                    
                    img.onerror = (error) => {
                        console.error('图片加载失败:', error);
                        this.simulateQRResult();
                    };
                    
                    console.log('设置图片源:', this.qrImage.src.substring(0, 50) + '...');
                    img.src = this.qrImage.src;
                    
                } catch (error) {
                    console.error('二维码识别出错:', error);
                    this.simulateQRResult();
                }
            }
            
            tryEnhancedRecognition(canvas, ctx, originalImageData) {
                console.log('尝试图像增强识别...');
                
                // 尝试多种二值化阈值
                const thresholds = [100, 128, 150, 80, 180];
                
                for (let threshold of thresholds) {
                    console.log(`尝试阈值: ${threshold}`);
                    const enhancedImageData = ctx.createImageData(originalImageData.width, originalImageData.height);
                    
                    for (let i = 0; i < originalImageData.data.length; i += 4) {
                        const avg = (originalImageData.data[i] + originalImageData.data[i + 1] + originalImageData.data[i + 2]) / 3;
                        const enhanced = avg > threshold ? 255 : 0;
                        
                        enhancedImageData.data[i] = enhanced;
                        enhancedImageData.data[i + 1] = enhanced;
                        enhancedImageData.data[i + 2] = enhanced;
                        enhancedImageData.data[i + 3] = 255;
                    }
                    
                    const code = jsQR(enhancedImageData.data, enhancedImageData.width, enhancedImageData.height);
                    console.log(`阈值${threshold}识别结果:`, code);
                    
                    if (code) {
                        console.log('增强识别成功! 内容:', code.data);
                        this.handleQRResult(code.data);
                        return;
                    }
                }
                
                // 尝试对比度增强
                this.tryContrastEnhancement(canvas, ctx, originalImageData);
            }
            
            tryContrastEnhancement(canvas, ctx, originalImageData) {
                console.log('尝试对比度增强识别...');
                
                // 对比度增强
                const contrastImageData = ctx.createImageData(originalImageData.width, originalImageData.height);
                const contrast = 2.0; // 对比度倍数
                const brightness = 0;  // 亮度调整
                
                for (let i = 0; i < originalImageData.data.length; i += 4) {
                    let r = originalImageData.data[i];
                    let g = originalImageData.data[i + 1];
                    let b = originalImageData.data[i + 2];
                    
                    // 应用对比度和亮度
                    r = Math.min(255, Math.max(0, contrast * (r - 128) + 128 + brightness));
                    g = Math.min(255, Math.max(0, contrast * (g - 128) + 128 + brightness));
                    b = Math.min(255, Math.max(0, contrast * (b - 128) + 128 + brightness));
                    
                    contrastImageData.data[i] = r;
                    contrastImageData.data[i + 1] = g;
                    contrastImageData.data[i + 2] = b;
                    contrastImageData.data[i + 3] = 255;
                }
                
                const code = jsQR(contrastImageData.data, contrastImageData.width, contrastImageData.height);
                console.log('对比度增强识别结果:', code);
                
                if (code) {
                    console.log('对比度增强识别成功! 内容:', code.data);
                    this.handleQRResult(code.data);
                } else {
                    // 尝试多种缩放比例
                    this.tryScaledRecognition(canvas, ctx, originalImageData);
                }
            }
            
            tryScaledRecognition(canvas, ctx, originalImageData) {
                console.log('尝试多种缩放识别...');
                
                // 尝试多种缩放比例
                const scaleFactors = [1.5, 2, 0.5, 3, 0.3];
                
                for (let scaleFactor of scaleFactors) {
                    console.log(`尝试缩放比例: ${scaleFactor}`);
                    const scaledCanvas = document.createElement('canvas');
                    const scaledCtx = scaledCanvas.getContext('2d');
                    
                    scaledCanvas.width = Math.floor(originalImageData.width * scaleFactor);
                    scaledCanvas.height = Math.floor(originalImageData.height * scaleFactor);
                    
                    // 重新绘制缩放的图像
                    ctx.putImageData(originalImageData, 0, 0);
                    scaledCtx.imageSmoothingEnabled = false; // 避免模糊
                    scaledCtx.drawImage(canvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
                    
                    const scaledImageData = scaledCtx.getImageData(0, 0, scaledCanvas.width, scaledCanvas.height);
                    const code = jsQR(scaledImageData.data, scaledImageData.width, scaledImageData.height);
                    console.log(`缩放${scaleFactor}识别结果:`, code);
                    
                    if (code) {
                        console.log('缩放识别成功! 内容:', code.data);
                        this.handleQRResult(code.data);
                        return;
                    }
                }
                
                // 尝试锐化处理
                this.trySharpenRecognition(canvas, ctx, originalImageData);
            }
            
            trySharpenRecognition(canvas, ctx, originalImageData) {
                console.log('尝试锐化识别...');
                
                // 锐化滤镜核
                const sharpenKernel = [
                    0, -1, 0,
                    -1, 5, -1,
                    0, -1, 0
                ];
                
                const width = originalImageData.width;
                const height = originalImageData.height;
                const sharpenImageData = ctx.createImageData(width, height);
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        let r = 0, g = 0, b = 0;
                        
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4;
                                const kernelIdx = (ky + 1) * 3 + (kx + 1);
                                const kernelValue = sharpenKernel[kernelIdx];
                                
                                r += originalImageData.data[idx] * kernelValue;
                                g += originalImageData.data[idx + 1] * kernelValue;
                                b += originalImageData.data[idx + 2] * kernelValue;
                            }
                        }
                        
                        const idx = (y * width + x) * 4;
                        sharpenImageData.data[idx] = Math.min(255, Math.max(0, r));
                        sharpenImageData.data[idx + 1] = Math.min(255, Math.max(0, g));
                        sharpenImageData.data[idx + 2] = Math.min(255, Math.max(0, b));
                        sharpenImageData.data[idx + 3] = 255;
                    }
                }
                
                const code = jsQR(sharpenImageData.data, sharpenImageData.width, sharpenImageData.height);
                console.log('锐化识别结果:', code);
                
                if (code) {
                    console.log('锐化识别成功! 内容:', code.data);
                    this.handleQRResult(code.data);
                } else {
                    console.log('所有识别方法都失败了');
                    this.updateStatus('error', '🔍 识别失败！建议：1.检查图片清晰度 2.确保二维码完整 3.尝试更高质量的图片');
                }
            }
            
            simulateQRResult() {
                // 模拟识别结果
                const mockData = 'https://u.wechat.com/ELAxxxxxxxxxxxx';
                this.updateStatus('success', '识别成功！发现微信添加好友链接');
                
                setTimeout(() => {
                    this.handleQRResult(mockData);
                }, 1000);
            }
            
            handleQRResult(qrData) {
                console.log('二维码内容:', qrData);
                
                // 检查是否是微信相关链接
                if (qrData.includes('wechat.com') || qrData.includes('weixin') || qrData.includes('u.wechat.com')) {
                    this.updateStatus('success', '检测到微信二维码！正在跳转...');
                    
                    setTimeout(() => {
                        this.redirectToWeChat(qrData);
                    }, 1500);
                } else if (qrData.startsWith('http')) {
                    this.updateStatus('success', '检测到网页链接！正在跳转...');
                    
                    setTimeout(() => {
                        window.open(qrData, '_blank');
                        this.updateStatus('success', '已在新窗口打开链接');
                    }, 1500);
                } else {
                    this.updateStatus('success', `识别到内容: ${qrData}`);
                }
                
                // 3秒后重置状态
                setTimeout(() => {
                    this.resetProgress();
                    this.updateStatus('idle', '识别完成！点击图片可重新识别...');
                }, 3000);
            }
            
            redirectToWeChat(qrData) {

                console.log(qrData);
                // 尝试打开微信
                const userAgent = navigator.userAgent.toLowerCase();
                
                if (userAgent.includes('micromessenger')) {
                    // 在微信内部，直接跳转
                    window.location.href = qrData;
                } else if (userAgent.includes('mobile')) {
                    // 移动端，尝试使用微信scheme
                    const wechatScheme = `weixin://dl/business/?t=9XPl7k7i2lC`;
                    window.location.href = wechatScheme;
                    
                    // 如果微信scheme失败，提示用户
                    setTimeout(() => {
                        this.updateStatus('error', '请在微信中打开或复制链接到微信');
                    }, 2000);
                } else {
                    // 桌面端，显示提示信息
                    this.updateStatus('success', '检测到微信二维码！请在手机微信中扫描');
                    
                    // 创建提示弹窗
                    this.showWeChatTip(qrData);
                }
            }
            
            showWeChatTip(qrData) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        text-align: center;
                        max-width: 400px;
                        margin: 20px;
                    ">
                        <h3>🎯 识别成功！</h3>
                        <p style="margin: 15px 0;">检测到微信添加好友二维码</p>
                        <p style="color: #666; font-size: 14px;">请使用手机微信扫描此二维码</p>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            margin-top: 20px;
                            padding: 10px 25px;
                            background: #1aad19;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">我知道了</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 3秒后自动关闭
                setTimeout(() => {
                    if (modal.parentElement) {
                        modal.remove();
                    }
                }, 5000);
            }
            
            updateStatus(type, message) {
                this.statusText.className = `status-text ${type}`;
                this.statusText.textContent = message;
            }
            
            // 自动开始识别
            autoStartRecognition() {
                // 添加随机延迟，模拟真实用户行为
                const randomDelay = 800 + Math.random() * 1200; // 0.8-2秒随机延迟
                
                this.updateStatus('pressing', '🤖 自动识别中...使用多种算法提升识别率');
                
                setTimeout(() => {
                    // 直接调用startPress而不是模拟事件（避免事件冲突）
                    this.startPress({ type: 'auto', target: this.qrImage });
                }, randomDelay);
            }
            
            // 启动人类随机性模拟
            startHumanRandomness() {
                // 每100-300ms执行一次随机效果
                this.humanRandomnessTimer = setInterval(() => {
                    this.addHumanRandomness();
                }, 100 + Math.random() * 200);
            }
            
            // 高级事件模拟（用于手动点击触发）
            advancedEventSimulation() {
                console.log('开始高级事件模拟...');
                
                const rect = this.qrImage.getBoundingClientRect();
                
                // 添加随机偏移，模拟不精确的触摸
                const randomX = rect.left + rect.width/2 + (Math.random() - 0.5) * 20;
                const randomY = rect.top + rect.height/2 + (Math.random() - 0.5) * 20;
                
                // 创建模拟的事件对象
                const mockEvent = {
                    type: 'simulated_touch',
                    target: this.qrImage,
                    clientX: randomX,
                    clientY: randomY,
                    preventDefault: () => {},
                    stopPropagation: () => {},
                    // 模拟isTrusted为true (尽管实际上不会生效，但增加真实性)
                    isTrusted: true,
                    timeStamp: Date.now(),
                    detail: 1
                };
                
                // 添加随机的预触摸延迟
                const preDelay = 50 + Math.random() * 150;
                
                setTimeout(() => {
                    // 开始长按
                    this.startPress(mockEvent);
                    
                    // 在长按过程中添加微小的"手抖"模拟
                    const shakeDuration = this.LONG_PRESS_DURATION * 0.8;
                    const shakeInterval = setInterval(() => {
                        if (this.isPressed) {
                            // 轻微改变图片的位置模拟手抖
                            const shakeX = (Math.random() - 0.5) * 2;
                            const shakeY = (Math.random() - 0.5) * 2;
                            this.qrImage.style.transform = `scale(0.98) translate(${shakeX}px, ${shakeY}px)`;
                        } else {
                            clearInterval(shakeInterval);
                        }
                    }, 100 + Math.random() * 100);
                    
                    setTimeout(() => {
                        clearInterval(shakeInterval);
                    }, shakeDuration);
                    
                }, preDelay);
                
                console.log('高级事件模拟已启动，使用随机参数:', {
                    x: randomX.toFixed(2),
                    y: randomY.toFixed(2),
                    preDelay: preDelay.toFixed(0) + 'ms',
                    duration: this.LONG_PRESS_DURATION.toFixed(0) + 'ms'
                });
            }
            
            // 模拟真实触摸事件（改进版）
            simulateRealTouch() {
                // 这个方法保留用于更复杂的DOM事件模拟
                console.log('模拟真实DOM事件...');
                
                const rect = this.qrImage.getBoundingClientRect();
                const randomX = rect.left + rect.width/2 + (Math.random() - 0.5) * 20;
                const randomY = rect.top + rect.height/2 + (Math.random() - 0.5) * 20;
                
                // 创建更简单但有效的鼠标事件
                try {
                    const mouseDown = new MouseEvent('mousedown', {
                        bubbles: true,
                        cancelable: true,
                        view: window,
                        clientX: randomX,
                        clientY: randomY,
                        button: 0,
                        buttons: 1,
                        detail: 1
                    });
                    
                    // 分派鼠标按下事件
                    this.qrImage.dispatchEvent(mouseDown);
                    
                    // 随机延迟后分派鼠标释放事件
                    const holdTime = 1300 + Math.random() * 500;
                    setTimeout(() => {
                        const mouseUp = new MouseEvent('mouseup', {
                            bubbles: true,
                            cancelable: true,
                            view: window,
                            clientX: randomX + (Math.random() - 0.5) * 5,
                            clientY: randomY + (Math.random() - 0.5) * 5,
                            button: 0,
                            buttons: 0,
                            detail: 1
                        });
                        
                        this.qrImage.dispatchEvent(mouseUp);
                    }, holdTime);
                    
                    console.log('真实DOM事件已分派');
                    
                } catch (error) {
                    console.warn('DOM事件创建失败，使用高级模拟:', error);
                    this.advancedEventSimulation();
                }
            }
            
            // 创建TouchList的辅助方法（改进兼容性）
            createTouchList(x, y) {
                try {
                    // 现代浏览器支持Touch构造函数
                    const touch = new Touch({
                        identifier: Date.now(),
                        target: this.qrImage,
                        clientX: x,
                        clientY: y,
                        pageX: x,
                        pageY: y,
                        screenX: x,
                        screenY: y,
                        radiusX: 11.5,
                        radiusY: 11.5,
                        rotationAngle: 0,
                        force: 0.5
                    });
                    
                    return [touch];
                } catch (e) {
                    // 降级处理：创建类似Touch的对象
                    console.warn('Touch constructor not supported, using fallback');
                    return [{
                        identifier: Date.now(),
                        target: this.qrImage,
                        clientX: x,
                        clientY: y,
                        pageX: x,
                        pageY: y,
                        screenX: x,
                        screenY: y,
                        radiusX: 11.5,
                        radiusY: 11.5,
                        rotationAngle: 0,
                        force: 0.5
                    }];
                }
            }
            
            // 高级反检测：模拟浏览器环境检查
            checkEnvironment() {
                // 检查是否在微信环境
                const userAgent = navigator.userAgent.toLowerCase();
                const isWeChat = userAgent.includes('micromessenger');
                
                if (isWeChat) {
                    // 在微信中添加额外的延迟和随机性
                    this.LONG_PRESS_DURATION += Math.random() * 300;
                    this.PROGRESS_INTERVAL += Math.random() * 15;
                    
                    // 模拟微信特有的行为模式
                    this.addWeChatBehaviorPattern();
                }
                
                return isWeChat;
            }
            
            // 添加微信特有的行为模式
            addWeChatBehaviorPattern() {
                // 模拟用户在微信中的典型行为
                setTimeout(() => {
                    // 模拟用户查看页面的行为
                    window.scrollTo({
                        top: window.scrollY + (Math.random() - 0.5) * 50,
                        behavior: 'smooth'
                    });
                }, 500 + Math.random() * 1000);
                
                // 添加页面focus/blur事件模拟
                setTimeout(() => {
                    document.dispatchEvent(new Event('visibilitychange'));
                }, 200 + Math.random() * 500);
            }
            
            // 模拟人类操作的随机性
            addHumanRandomness() {
                // 在长按过程中添加轻微的"手抖"效果
                if (this.isPressed && Math.random() < 0.3) {
                    // 30%概率添加微小的视觉反馈变化
                    this.qrImage.style.transform = `scale(0.98) rotate(${(Math.random() - 0.5) * 0.5}deg)`;
                    
                    setTimeout(() => {
                        this.qrImage.style.transform = 'scale(0.98)';
                    }, 50 + Math.random() * 100);
                }
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            const detector = new QRLongPressDetector();
            
            // 检查环境并调整行为
            const isWeChat = detector.checkEnvironment();
            
            // 自动启动识别（根据环境调整延迟）
            const baseDelay = isWeChat ? 1500 : 1000; // 微信环境延迟更长
            const randomDelay = baseDelay + Math.random() * 1000;
            
            setTimeout(() => {
                detector.autoStartRecognition();
            }, randomDelay);
            
            // 添加页面可见性变化监听（增加真实性）
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('页面隐藏，暂停操作');
                } else {
                    console.log('页面显示，恢复操作');
                }
            });
        });
    </script>
</body>
</html> 